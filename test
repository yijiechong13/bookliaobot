from telegram.ext import Application, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ConversationHandler, JobQueue
from mainhandlers import *
from hosthandlers import *
from joingamehandlers import *
from config import * 
from dotenv import load_dotenv
import os
load_dotenv()
TOKEN = os.getenv("BOT_TOKEN")
FIREBASE_CREDENTIALS = os.getenv("FIREBASE_CREDENTIALS")
from firebase_init import db

# Define conversation states
MENU_STATE, SPORT_STATE, RESULTS_STATE = range(3)

async def start_filter(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    await update.callback_query.answer()
    context.user_data.update({'filters': {}, 'page': 0, 'games': []})
    return await show_menu(update, "üîç Filter games by:")

async def show_menu(update: Update, text: str) -> int:
    menu = [
        ["‚öΩ Sports", "filter_sport"],
        ["üïí Time", "filter_time"],
        ["üìç Venue", "filter_venue"],
        ["üìä Skill", "filter_skill"],
        ["üîç Results", "show_results"]
    ]
    keyboard = [[InlineKeyboardButton(t, callback_data=d)] for t, d in menu]
    keyboard.append([InlineKeyboardButton("üîô Back", callback_data="back")])
    
    if update.callback_query:
        await update.callback_query.edit_message_text(
            text=text, 
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
    else:
        await update.message.reply_text(
            text=text,
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
    return MENU_STATE

async def handle_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data = query.data
    
    if data == "filter_sport":
        return await sport_menu(update, context)
    elif data == "show_results":
        return await show_results(update, context)
    else:
        return await show_menu(update, "Main Menu")

async def sport_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    sports = {d.to_dict().get("sport") for d in db.collection("game").stream() if d.to_dict().get("sport")}
    selected = context.user_data.setdefault('filters', {}).get('sport', []) or []
    
    keyboard = [
        [InlineKeyboardButton(
            f"{'‚úÖ ' if s in selected else '‚ö™ '}{s}", 
            callback_data=f"toggle_{s}")]
        for s in sorted(sports)
    ]
    keyboard += [[
        InlineKeyboardButton("üîô Back", callback_data="back"),
        InlineKeyboardButton("Apply", callback_data="apply_filters")
    ]]
    
    await update.callback_query.edit_message_text(
        "Select sports:", 
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
    return SPORT_STATE

async def toggle_sport(update: Update, context: ContextTypes.DEFAULT_TYPE):
    sport = update.callback_query.data.split('_')[1]
    selected = context.user_data.setdefault('filters', {}).setdefault('sport', [])
    
    if sport in selected:
        selected.remove(sport)
    else:
        selected.append(sport)
    
    return await sport_menu(update, context)

async def apply_filters(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.callback_query.answer()
    context.user_data['page'] = 0
    return await show_results(update, context)

async def show_results(update: Update, context: ContextTypes.DEFAULT_TYPE):
    filters = context.user_data.get('filters', {})
    query = db.collection("game")
    
    if sports := filters.get('sport'):
        query = query.where('sport', 'in', [sports] if isinstance(sports, str) else sports)
    
    games = [d.to_dict() for d in query.stream()]
    context.user_data.update({
        'games': games,
        'page': 0,
        'current_game': games[0] if games else None
    })
    
    if not games:
        await update.callback_query.edit_message_text("‚ùå No matches found")
        return MENU_STATE
    
    await display_game(update, context)
    return RESULTS_STATE

async def display_game(update: Update, context: ContextTypes.DEFAULT_TYPE):
    game = context.user_data['current_game']
    page = context.user_data['page']
    games = context.user_data['games']
    
    text = (
        f"üéØ Game {page+1}/{len(games)}\n"
        f"üèÄ Sport: {game.get('sport')}\n"
        f"üïí Time: {game.get('time')}\n"
        f"üìç Venue: {game.get('venue')}\n"
        f"üë• Players: {game.get('players', 0)}/{game.get('max_players', 10)}"
    )
    
    nav_buttons = []
    if len(games) > 1:
        nav_buttons = [
            InlineKeyboardButton("‚¨ÖÔ∏è", callback_data="prev"),
            InlineKeyboardButton(f"{page+1}/{len(games)}", callback_data="page"),
            InlineKeyboardButton("‚û°Ô∏è", callback_data="next")
        ]
    
    reply_markup = InlineKeyboardMarkup([nav_buttons, [
        InlineKeyboardButton("‚úÖ Join", callback_data="join"),
        InlineKeyboardButton("üîô Menu", callback_data="menu")
    ]])
    
    await update.callback_query.edit_message_text(text, reply_markup=reply_markup)

async def handle_navigation(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    if query.data == "next":
        context.user_data['page'] = min(
            context.user_data['page'] + 1,
            len(context.user_data['games']) - 1
        )
    elif query.data == "prev":
        context.user_data['page'] = max(0, context.user_data['page'] - 1)
    
    context.user_data['current_game'] = context.user_data['games'][context.user_data['page']]
    await display_game(update, context)
    return RESULTS_STATE

async def join_game(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    game = context.user_data['current_game']
    
    await db.collection("game").document(game['id']).update({
        'players': firestore.Increment(1),
        'players_list': firestore.ArrayUnion([update.effective_user.id])
    })
    
    await query.edit_message_text(
        f"‚úÖ Joined {game.get('sport')} game!\n"
        f"Group: {game.get('group_link', 'Contact organizer')}"
    )
    return ConversationHandler.END

def main():
    application = Application.builder().token(TOKEN).build()
    
    conv_handler = ConversationHandler(
        entry_points=[CallbackQueryHandler(start_filter, pattern="^start$")],
        states={
            MENU_STATE: [
                CallbackQueryHandler(handle_menu, pattern=r"^filter_|^show_|^back$")
            ],
            SPORT_STATE: [
                CallbackQueryHandler(toggle_sport, pattern=r"^toggle_"),
                CallbackQueryHandler(apply_filters, pattern="^apply_filters$")
            ],
            RESULTS_STATE: [
                CallbackQueryHandler(handle_navigation, pattern=r"^prev$|^next$"),
                CallbackQueryHandler(join_game, pattern="^join$"),
                CallbackQueryHandler(show_menu, pattern="^menu$")
            ]
        },
        fallbacks=[]
    )
    
    application.add_handler(conv_handler)
    application.run_polling()

if __name__ == "__main__":
    main()